---
import { getAPIPath, JSONConvertToHTML, makeWordsClickable, optimizeImageUrl, shuffleArray } from "../../js/utils";
import PanelLayout from "../../layouts/PanelLayout.astro";
import SMM_panelCards_related from "../../components/SMM_panelCards_related.astro"

//import servicePlatformsData from "../../data/temp-services";
const allServicesFetch = await fetch(getAPIPath() + "api/services.json");
const allServices = allServicesFetch.ok ? await allServicesFetch.json() : [];

const randomPanelsRes = await fetch(getAPIPath() + "api/panels.json");
let randomPanelsList = randomPanelsRes.ok ? await randomPanelsRes.json() : [];
export const prerender = true;
export async function getStaticPaths() {
    const allPanelsFetch = await fetch(getAPIPath() + "api/panels.json");
    const allPanelRes: panelSchema[] = allPanelsFetch.ok ? await allPanelsFetch.json() : [];
    
    return allPanelRes.map((panel: any) => ({
        params: { slug: panel.panelSlug },
        props: { panel },
    }));
}

const { panel } = Astro.props;
const { slug } = Astro.params;
// console.log(panel);

var ratingCollection: String[] = [];
for (let j = 0; j < 5; j++) {
    if (j < panel.rating) ratingCollection.push("fa-solid fa-star");
    else ratingCollection.push("fa-regular fa-star");
}

// console.log("Rating Stars Classes", ratingCollection);

var servicesResponse = [];
var platformList: any = [];
var platformListTitles: any = [];
try {
    try {
        servicesResponse = await fetch(`${panel.panelAPILink}?key=${panel.panelAPIKey}&action=services`).then(Response => Response.json());
    } catch (error) {
        console.log(`${panel.panelAPILink}?key=${panel.panelAPIKey}&action=services` + "- Could not Find Services with GET Method");
        servicesResponse = [];
    }

    try {
        //Fallback to fetch with GET Request
        if(servicesResponse.length==0){
            servicesResponse = await fetch(`${panel.panelAPILink}?key=${panel.panelAPIKey}&action=services`, {method:'POST'}).then(Response => Response.json());
        }
    } catch (error) {
        console.log(`${panel.panelAPILink}?key=${panel.panelAPIKey}&action=services` + "- Could not Find Services with POST Method");
        servicesResponse = [];
    }
    
    let allServiceNames: string[] = [];
    // Ensure servicesResponse is a valid array before processing
    if (!Array.isArray(servicesResponse)) {
        console.warn('Panel services response is not an array:', typeof servicesResponse);
        servicesResponse = [];
    }

    if(servicesResponse.length > 0) {
        servicesResponse.forEach((service: any) => {
            // Safely handle service.name - could be null, undefined, or not a string
            if (service && service.name != null) {
                const nameStr = typeof service.name === 'string' ? service.name : String(service.name);
                allServiceNames.push(nameStr.toLowerCase());
            }
        });

        for (let i = 0; i < allServices.length; i++) {
            for (let j = 0; j < allServiceNames.length; j++) {
                if (isSame(allServiceNames[j], allServices[i].serviceTitle)) {
                    if (platformList.includes(allServices[i]) == false)
                        platformList.push(allServices[i]);
                }
            }
        }
    }
} catch (error) {
    console.log(error);
    console.log("Could not Find Services and API URL is not correct.");
}

platformList.map((services:any)=>(
    platformListTitles.push(services.serviceTitle.toLowerCase())
));

function isSame(APIService: string, platformSavedService: string) {
    if (APIService.toLowerCase().includes(platformSavedService.toLowerCase()))
        return true;
}

interface panelSchema {
    id: string;
    paneFeaturedImage: {
        url: string;
    };
    panelAPIKey: string;
    panelAPILink: string;
    panelTitle: string;
    panelWebsiteURL: string;
    panelSlug: string;
    panelTextDescrition: string;
    panelMetaDesc: string;
    panelTotalServices: number;
    rating: number;
    ratingOtherSites: [{
        score : string,
        ratingURL :string,
        ratingSite :string,
        TotalReviews : string
    }];
    paymentOptions: [{
        payDepo: string;
        payOption: string;
    }];
}


for (let i = 0; i < randomPanelsList.length; i++) {
        if(randomPanelsList[i].panelSlug === slug)
            randomPanelsList.splice(i, 1);
    }
    
randomPanelsList = shuffleArray(randomPanelsList);
// console.log(makeWordsClickable(JSONConvertToHTML(panel.panelTextDescrition), platformList));

---

<PanelLayout 
    title={panel.panelTitle} 
    metaDescription={panel.panelMetaDesc} 
    pageType="article"
    pageFeaturedImage={optimizeImageUrl(panel.paneFeaturedImage.url, 720, "webp")}>
    
    <div class="content-wrapper flex flex-wrap lg:justify-start justify-center gap-5 my-6 px-5">
        <article class="flex flex-col gap-5">
            <h1 class="text-4xl font-bold">{panel.panelTitle}</h1>
            <img
                src={optimizeImageUrl(panel.paneFeaturedImage.url, 720, "webp")}
                alt={panel.panelTitle + " Panel Image"}
                class="shadow-lg rounded-lg"
            />
            <span class="w-full flex justify-center items-center">
                <a
                    target="_blank"
                    class="rounded-lg p-3 bg-blue-600 text-white"
                    href={panel.panelWebsiteURL}>Visit {panel.panelTitle}</a
                >
            </span>
            <div class="article-wrapper flex lg:flex-row flex-col gap-4">
                <div class="post-content lg:w-4/6 w-full flex flex-col gap-4">
                    <!-- Panels Text Content Goes Here -->
                    <div class="content" set:html={makeWordsClickable(JSONConvertToHTML(panel.panelTextDescrition), platformListTitles)}></div>

                    <div class="aboutPanel flex justify-between items-center">
                        {
                            servicesResponse.length > 0 &&
                            <h2 class="text-3xl font-semibold">
                                Total number of Services - {servicesResponse.length}
                            </h2>
                        }
                    </div>

                    {
                        servicesResponse.length > 0 &&
                        <h2 class="text-3xl font-semibold">
                            {panel.panelTitle} provides services for these platforms:
                        </h2>
                        <div class="services-cloud flex flex-wrap gap-3 text-white">
                            {
                                platformList.length != 0 &&
                                platformList.map((service: any) => (
                                    <a
                                        href={
                                            "/services/" +
                                            service.serviceTitle
                                                .toLowerCase()
                                                .replaceAll(" ", "-")
                                        }
                                        class="lg:px-4 px-2 capitalize lg:py-2 py-1 lg:text-base text-[15px] rounded-md cursor-pointer hover:brightness-75"
                                        style={`background-color: ${service.serviceColor}`}
                                    >
                                        {service.serviceTitle}
                                    </a>
                                ))
                            }
                        </div>
                    }
                </div>
                <aside class="lg:w-2/6 w-full">
                    <!-- Payment Options -->
                    <div
                        class="paymentOptions w-full mb-4 bg-white p-3 rounded-md shadow-md">
                        <h2 class="text-3xl font-semibold">Payment Options</h2>

                        <div class="table w-full mt-4">
                            <div
                                class="header flex w-full p-2 font-semibold bg-gray-300"
                            >
                                <div class="col w-1/2">Method</div>
                                <div class="col w-1/2">Minimum Deposit</div>
                                <div class="col w-1/2">Bonus</div>
                            </div>
                            {
                                panel.paymentOptions.map((paymentOp: any) => (
                                    <div class="row flex w-full p-2">
                                        <div class="col w-1/2">
                                            {paymentOp.payOption}
                                        </div>
                                        <div class="col w-1/2">
                                            {paymentOp.payDepo}
                                        </div>
                                        <div class="col w-1/2">
                                            {paymentOp.payBonus || "-"}
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>

                    <!-- Rating -->
                    <div class="reviewsBox mb-4 flex gap-3 items-center bg-white p-3 rounded-md shadow-md">
                        <h2 class="text-3xl font-semibold">Rating -</h2>
                        <span class="flex gap-2 text-yellow-400 text-2xl">
                            {
                                ratingCollection.map((rating) => (
                                    <i class={rating.toString()} />
                                ))
                            }
                        </span>
                    </div>

                </aside>
            </div>

            <div class="otherReviews-Container w-full mt-5 flex lg:flex-row flex-col justify-center items-center lg:gap-x-12 gap-5">
                
                {
                    (panel.ratingOtherSites != null )  &&
                    panel.ratingOtherSites.map((rating:any)=>(
                        rating.ratingURL != "" &&
                        (
                            <a target="_blank"href={rating.ratingURL} class="reviewsBox lg:w-fit md:w-1/2 w-full mb-4 flex flex-col gap-3 items-center bg-white p-3 rounded-md shadow-md">
                                <img src={ "/assets/images/" + 
                                    (rating.ratingSite == "TrustPilot" ?
                                    "trustpilotlogo.webp"
                                    :
                                    rating.ratingSite == "Sitejabber" ?
                                    "Sitejabber_logo.png"
                                    :
                                    "reviewsLogo.webp")
                                } alt={rating.ratingSite + " logo"} class="h-10 lg:w-45 w-full object-contain" />
                                <span class="flex gap-2 font-bold text-[#36304a] text-2xl">
                                    {
                                        `${rating.score} / 5 (${rating.TotalReviews} reviews)` 
                                    }
                                </span>
                            </a>
                        )
                    ))
                }

            </div>

            {
                (servicesResponse.length > 0 ) && (
                    <h2 class="text-3xl font-semibold">20 Latest Services by {panel.panelTitle}</h2>
                    <div class="services-table-holder shadow-2xl mt-5 lg:w-full w-[89vw] overflow-auto">
                        <div class="table-wrapper md:w-full w-175 ">
                            <span class="offerHeader w-full flex bg-[#36304a] font-semibold text-white ">
                                <span class="offer_id my-6 w-[5%] pl-2">
                                    S.No
                                </span>
                                <span class="offer_service my-6 w-[41%]">
                                    Service
                                </span>
                                <span class="offer_Minorder my-6 w-[18%]">
                                    Min order
                                </span>
                                <span class="offer_Maxorder my-6 w-[18%]">
                                    Max order
                                </span>
                                <span class="offer_rate my-6 w-[18%]">
                                    Rate per 1000
                                </span>
                            </span>

                            {servicesResponse.slice(0, 20)
                                .map((service: any, j: number) => (
                                    <span class="offerList w-full flex border-b border-gray-400">
                                        <span class="offer_id line-clamp-1 my-3 w-[5%] pl-2">
                                            {j + 1}
                                        </span>
                                        <span
                                            class="offer_service line-clamp-1 my-3 w-[41%] text-left"
                                            title={service.name}
                                        >
                                            {service.name}
                                        </span>
                                        <span class="offer_Minorder line-clamp-1 my-3 w-[18%]">
                                            {service.min}
                                        </span>
                                        <span class="offer_Maxorder line-clamp-1 my-3 w-[18%]">
                                            {service.max}
                                        </span>
                                        <span class="offer_rate line-clamp-1 my-3 w-[18%]">
                                            ${service.rate}
                                        </span>
                                    </span>
                                ))}
                        </div>
                    </div>
                )
            }

            <!-- {
                servicesResponse.length > 20 && 
                <div class="button w-full flex justify-center items-center hidden">
                    <a class="rounded-full px-3 py-2 bg-[#333333] text-white" href={"/allServer/"+slug} >Show All</a>
                </div>
            } -->
        </article>

        <h2 class="mt-4 text-2xl font-semibold">You may also like:</h2>
        <div class="relatedPanels-container my-4 flex lg:flex-row flex-col flex-wrap gap-3 justify-between">
            {
                randomPanelsList.slice(0, 3).map((panel:any)=>(
                    <SMM_panelCards_related
                        imageSrc={
                            panel.paneFeaturedImage == null
                                ? ""
                                : optimizeImageUrl(
                                      panel.paneFeaturedImage.url,
                                      250,
                                  )
                        }
                        panelTitle={panel.panelTitle}
                        slugURL={panel.panelSlug}
                    />
                ))
            }
        </div>
    </div>
</PanelLayout>


<style is:inline>
    .content h1{
        font-size: 22px;
        font-weight: 600;
        padding-bottom: 15px;
        padding-top: 10px;
    }
    .content h2{
        font-size: 20px;
        font-weight: 500;
        padding-bottom: 15px;
        padding-top: 10px;
    }
    .content h3{
        font-size: 19px;
        font-weight: 500;
        padding-bottom: 15px;
        padding-top: 10px;
    }
    .content h4{
        font-size: 17px;
        font-weight: 500;
        padding-bottom: 15px;
        padding-top: 10px;
    }
    .content h5{
        font-size: 16px;
        font-weight: 500;
        padding-bottom: 15px;
        padding-top: 10px;
    }
    .content h6{
        font-size: 15px;
        font-weight: 500;
        padding-bottom: 15px;
        padding-top: 10px;
    }
    .content ol{
        list-style-type: decimal;
        padding-left: 2rem;
    }
    .content p{
        padding-bottom: 15px;
        padding-top: 10px;
    }

    .content a{
        color: blue;
    }
    .content a:hover{
        text-decoration-line: underline;
    }
</style>